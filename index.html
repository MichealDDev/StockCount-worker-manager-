<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <link rel="icons" href="icons.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Count Manager</title>
    <style>
        :root {
            --primary-color: #007cba;
            --primary-light: #e6f7ff;
            --secondary-color: #f0f0f0;
            --text-color: #333;
            --text-secondary: #666;
            --bg-color: #ffffff;
            --card-bg: #f9f9f9;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --danger-color: #dc3545;
            --danger-bg: #fde8e9;
            --success-color: #28a745;
            --success-bg: #d4edda;
        }

        .dark-mode {
            --primary-color: #4da6ff;
            --primary-light: #2c425b;
            --secondary-color: #333;
            --text-color: #f0f0f0;
            --text-secondary: #b0b0b0;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --border-color: #2c2c2c;
            --shadow-color: rgba(255, 255, 255, 0.05);
            --danger-color: #ff6b6b;
            --danger-bg: #5c2020;
            --success-color: #44b465;
            --success-bg: #2d4530;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .header h1 {
            color: var(--primary-color);
            margin: 0 0 5px;
            font-size: 2em;
        }

        .header p {
            margin: 0;
            color: var(--text-secondary);
        }

        .dark-mode-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            color: var(--text-color);
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }

        .dark-mode-toggle:hover {
            background-color: var(--secondary-color);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            background: none;
            border: none;
            padding: 15px 20px;
            font-size: 1.1em;
            cursor: pointer;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: color 0.3s, border-bottom-color 0.3s;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            font-weight: bold;
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form and Inputs */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="datetime-local"],
        .form-group input[type="file"],
        .form-group select,
        .form-group textarea,
        .search-container input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="datetime-local"]:focus,
        .form-group select:focus,
        .form-group textarea:focus,
        .search-container input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .notes-input {
            height: 100px;
            resize: vertical;
        }
        
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 5px var(--shadow-color);
            background-color: var(--primary-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.secondary {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        .btn.secondary:hover {
            background-color: #dcdcdc;
        }
        .dark-mode .btn.secondary:hover {
            background-color: #444;
        }
        
        .btn.danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn.danger:hover {
            background-color: #c82333;
        }

        /* Worker List */
        .worker-item, .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .worker-item:hover, .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow-color);
        }

        .worker-info h4, .history-info h4 {
            margin: 0 0 5px;
            color: var(--primary-color);
        }
        .worker-info p, .history-info p {
            margin: 0;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .worker-actions button, .history-actions button {
            margin-left: 10px;
        }

        .checkbox-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background-color: var(--card-bg);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
        }

        /* Count Time Tracking */
        .time-tracking-form {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .time-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .time-display {
            text-align: center;
            padding: 20px;
            background-color: var(--primary-light);
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* Stats */
        .stats-container {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-item {
            background-color: var(--primary-light);
            padding: 15px;
            border-radius: 8px;
            color: var(--primary-color);
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            color: var(--text-color);
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .full-width { width: 100%; }
        .mt-20 { margin-top: 20px; }
        .ml-auto { margin-left: auto; }
        
        .validation-error, .duplicate-warning {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .search-container {
            position: relative;
            margin-bottom: 10px;
        }
        .search-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            color: var(--text-secondary);
        }
        
        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 50px 0;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
        }
        .empty-state svg {
            width: 60px;
            height: 60px;
            color: var(--border-color);
        }

        .time-badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: normal;
        }

        .history-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        /* Notifications */
        .notification-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-bg);
            color: var(--success-color);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .notification-bar.show {
            opacity: 1;
            visibility: visible;
        }

        .notification-bar.danger {
            background-color: var(--danger-bg);
            color: var(--danger-color);
        }

        .quick-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }
        .quick-action-btn {
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-size: 1.5em;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .quick-action-btn:hover {
            transform: scale(1.1);
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 10px; }
            .tabs { flex-wrap: wrap; }
            .tab { font-size: 0.9em; padding: 10px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .time-fields { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Stock Count Manager</h1>
            <p>Manage worker lists and track stock counts</p>
            <button class="dark-mode-toggle" onclick="toggleDarkMode()">🌓</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('workers')">Workers</button>
            <button class="tab" onclick="switchTab('count')">Count</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('backup')">Backup</button>
        </div>

        <div id="workers" class="tab-content active">
            <div class="search-container">
                <input type="text" class="search-input" id="workerSearch" placeholder="Search workers..." onkeyup="filterWorkers()">
                <button class="search-clear" onclick="clearWorkerSearch()" style="display: none;">×</button>
            </div>

            <div id="workerForm">
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="displayName" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Account Name</label>
                    <input type="text" id="accountName" placeholder="john.doe" required>
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="accountNumber" placeholder="1234567890" required>
                </div>
                <div class="form-group">
                    <label>Bank</label>
                    <input type="text" id="bankName" placeholder="First Bank" required>
                </div>
                
                <button class="btn full-width" type="button" id="addWorkerBtn" onclick="handleAddWorker()">Add Worker</button>
                <button class="btn secondary full-width mt-20" type="button" id="cancelEditBtn" style="display: none;" onclick="cancelEdit()">Cancel</button>
            </div>
            
            <div id="workersList" class="mt-20"></div>
        </div>

        <div id="count" class="tab-content">
            <div class="time-tracking-form">
                <h3 style="margin-top: 0; color: var(--primary-color);">Count Schedule</h3>
                <div class="time-fields">
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="datetime-local" id="countStartTime">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="datetime-local" id="countEndTime">
                    </div>
                </div>
                <button class="btn secondary full-width" onclick="setCurrentTimes()">Set Current Times</button>
            </div>

            <div class="form-group">
                <label>Pharmacy Name</label>
                <input type="text" id="pharmacyName" placeholder="Main Pharmacy">
            </div>
            
            <div class="form-group">
                <label>Notes (Optional)</label>
                <textarea id="countNotes" class="notes-input" placeholder="Add any notes about this count..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Select Workers Present</label>
                <div class="search-container">
                    <input type="text" class="search-input" id="countWorkerSearch" placeholder="Search workers for count..." onkeyup="filterCountWorkers()">
                    <button class="search-clear" onclick="clearCountWorkerSearch()" style="display: none;">×</button>
                </div>
                <div id="workerCheckboxes" class="checkbox-list"></div>
            </div>
            
            <button class="btn full-width" onclick="startCount()" id="startCountBtn">Start Count</button>
            <button class="btn danger full-width mt-20" onclick="stopCount()" id="stopCountBtn" style="display: none;">Stop Count</button>
            
            <div id="countTimer" class="time-display" style="display: none;">
                <div style="font-size: 32px; color: var(--primary-color); font-weight: bold; margin-bottom: 10px;">
                    <span id="timerDisplay">00:00:00</span>
                </div>
                <div style="font-size: 16px; color: var(--text-color); margin-bottom: 5px;">
                    Started: <span id="startTimeDisplay">--:--</span>
                </div>
                <div style="font-size: 14px; color: var(--text-secondary);">Count in progress...</div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="stats-container">
                <h4>Count Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalCounts">0</div>
                        <div class="stat-label">Total Counts</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgWorkers">0</div>
                        <div class="stat-label">Avg Workers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="avgDuration">0m</div>
                        <div class="stat-label">Avg Duration</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="mostUsedWorker">-</div>
                        <div class="stat-label">Top Worker</div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn secondary" onclick="toggleSelectMode()">Select Multiple</button>
                <div id="selectModeControls" style="display: none; margin-top: 10px;">
                    <button class="btn" onclick="exportSelectedAsTxt()">Export as TXT</button>
                    <button class="btn" onclick="exportSelectedAsExcel()">Export as CSV</button>
                    <button class="btn secondary" onclick="selectAll()">Select All</button>
                    <button class="btn secondary" onclick="clearSelection()">Clear Selection</button>
                    <button class="btn danger" onclick="deleteSelected()">Delete Selected</button>
                </div>
            </div>
            <div id="historyList"></div>
        </div>

        <div id="backup" class="tab-content">
            <h3 style="margin-bottom: 20px; color: var(--text-color);">Data Backup & Restore</h3>
            
            <!-- Cloud Sync Section -->
            <div style="background-color: var(--primary-light); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h4 style="color: var(--primary-color); margin: 0 0 10px;">Cloud Sync</h4>
                <div class="form-group">
                    <label>Sync Key (save this to sync across devices)</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="syncKey" placeholder="Enter sync key or generate new" style="flex: 1;">
                        <button class="btn secondary" onclick="generateSyncKey()">Generate</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn" onclick="syncToCloud()">Upload to Cloud</button>
                    <button class="btn secondary" onclick="syncFromCloud()">Download from Cloud</button>
                    <button class="btn secondary" onclick="autoSyncToggle()" id="autoSyncBtn">Enable Auto-Sync</button>
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin: 10px 0 0;">
                    Last sync: <span id="lastSyncTime">Never</span> | Status: <span id="syncStatus">Offline</span>
                </p>
            </div>
            
            <div class="form-group">
                <label>Export All Data</label>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">Save all your workers and count history</p>
                <button class="btn" onclick="exportBackup()">Export Backup</button>
            </div>
            
            <div class="form-group">
                <label>Import Data</label>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px;">Restore from backup file (will merge with existing data)</p>
                <input type="file" id="backupFile" accept=".json" style="margin-bottom: 10px;">
                <button class="btn secondary" onclick="importBackup()">Import Backup</button>
            </div>
            
            <div class="form-group">
                <label>Clear All Data</label>
                <p style="font-size: 13px; color: var(--danger-color); margin-bottom: 10px;">This will permanently delete all workers and history</p>
                <button class="btn danger" onclick="clearAllData()">Clear All Data</button>
            </div>
            
            <div style="margin-top: 30px; padding: 15px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                <h4 style="color: var(--text-color); margin-bottom: 10px;">Current Data</h4>
                <p>Workers: <strong id="workerCount">0</strong></p>
                <p>Count Records: <strong id="historyCount">0</strong></p>
                <p>Storage Used: <strong id="storageUsed">0 KB</strong></p>
            </div>
        </div>

        <div id="notificationBar" class="notification-bar"></div>
    </div>

    <script>
        let workers = [];
        let countHistory = [];
        let editingWorkerId = null;
        let countInterval;
        let countStartTime;
        let selectMode = false;
        let selectedHistoryIds = new Set();
        let countSessionStartTime; // For persistent timer
        let autoSync = false;

        // Cloud sync configuration
        const CLOUD_API_BASE = 'https://api.jsonbin.io/v3/b';
        const JSONBIN_MASTER_KEY = '$2a$10$zW5s2G9B01prqLI9mnO.s.qTxwuk9qz2vHfKgwywg9LAigi0fhPRy';

        // Initialize app
        function initApp() {
            loadData();
            displayWorkers();
            displayWorkerCheckboxes();
            displayHistory();
            updateDataStats();
            loadSyncSettings();
            restoreCountSession();
        }

        // Cloud sync functions
        function loadSyncSettings() {
            const savedSyncKey = localStorage.getItem('syncKey');
            const savedAutoSync = localStorage.getItem('autoSync') === 'true';
            const lastSync = localStorage.getItem('lastSyncTime');
            
            if (savedSyncKey) {
                document.getElementById('syncKey').value = savedSyncKey;
            }
            
            autoSync = savedAutoSync;
            document.getElementById('autoSyncBtn').textContent = autoSync ? 'Disable Auto-Sync' : 'Enable Auto-Sync';
            document.getElementById('lastSyncTime').textContent = lastSync ? new Date(lastSync).toLocaleString() : 'Never';
        }

        function generateSyncKey() {
            const key = Math.random().toString(36).substr(2, 15) + Date.now().toString(36);
            document.getElementById('syncKey').value = key;
            localStorage.setItem('syncKey', key);
            showNotification('Sync key generated! Save this key to sync across devices.');
        }

        async function getOrCreateBin(existingSyncKey) {
            // If user already provided a bin id, use it
            if (existingSyncKey) return existingSyncKey;

            // Otherwise create a new bin (one-time)
            const resp = await fetch(`${CLOUD_API_BASE}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': JSONBIN_MASTER_KEY
                },
                body: JSON.stringify({ workers: [], countHistory: [], createdAt: new Date().toISOString() })
            });

            const json = await resp.json();
            if (resp.ok && json && json.metadata && json.metadata.id) {
                const newBinId = json.metadata.id;
                // persist and populate the UI input so user can copy/share or reuse
                localStorage.setItem('syncKey', newBinId);
                const input = document.getElementById('syncKey');
                if (input) input.value = newBinId;
                return newBinId;
            } else {
                const body = (await resp.text()).slice(0, 500);
                throw new Error(`Could not create bin: ${resp.status} ${resp.statusText} — ${body}`);
            }
        }

        async function syncToCloud(silent = false) {
            let syncKey = document.getElementById('syncKey').value.trim();

            try {
                // show UI status right away
                document.getElementById('syncStatus').textContent = 'Uploading...';

                // ensure we have a real JSONBin bin id (creates one if none provided)
                syncKey = await getOrCreateBin(syncKey);

                const data = {
                    workers,
                    countHistory,
                    lastModified: new Date().toISOString()
                };

                const response = await fetch(`${CLOUD_API_BASE}/${syncKey}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_MASTER_KEY
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Upload failed: ${response.status} ${response.statusText} ${text}`);
                }

                const now = new Date().toISOString();
                localStorage.setItem('lastSyncTime', now);
                localStorage.setItem('syncKey', syncKey);
                document.getElementById('lastSyncTime').textContent = new Date(now).toLocaleString();
                document.getElementById('syncStatus').textContent = 'Synced';

                if (!silent) showNotification('Data uploaded to cloud successfully!');
            } catch (error) {
                document.getElementById('syncStatus').textContent = 'Error';
                if (!silent) showNotification('Cloud sync failed. Check your connection.', 'danger');
                console.error('Sync error:', error);
            }
        }

        async function syncFromCloud() {
            let syncKey = document.getElementById('syncKey').value.trim();

            try {
                document.getElementById('syncStatus').textContent = 'Downloading...';

                // ensure we have a bin id (if none, this will create one, but creation returns an empty bin)
                syncKey = await getOrCreateBin(syncKey);

                const response = await fetch(`${CLOUD_API_BASE}/${syncKey}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_MASTER_KEY
                    }
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Download failed: ${response.status} ${response.statusText} ${text}`);
                }

                const result = await response.json();
                const cloudData = result.record || {};

                // Merge cloud data with local data (same logic you already use)
                if (cloudData.workers) {
                    cloudData.workers.forEach(cloudWorker => {
                        if (!workers.some(localWorker => localWorker.id === cloudWorker.id)) {
                            workers.push(cloudWorker);
                        }
                    });
                }

                if (cloudData.countHistory) {
                    cloudData.countHistory.forEach(cloudItem => {
                        if (!countHistory.some(localItem => localItem.id === cloudItem.id)) {
                            countHistory.push(cloudItem);
                        }
                    });
                }

                saveData();
                displayWorkers();
                displayWorkerCheckboxes();
                displayHistory();
                updateDataStats();

                const now = new Date().toISOString();
                localStorage.setItem('lastSyncTime', now);
                document.getElementById('lastSyncTime').textContent = new Date(now).toLocaleString();
                document.getElementById('syncStatus').textContent = 'Synced';

                showNotification('Data downloaded from cloud successfully!');
            } catch (error) {
                document.getElementById('syncStatus').textContent = 'Error';
                showNotification('Could not download from cloud. Check sync key and connection.', 'danger');
                console.error('Sync error:', error);
            }
        }

        function autoSyncToggle() {
            autoSync = !autoSync;
            localStorage.setItem('autoSync', autoSync);
            document.getElementById('autoSyncBtn').textContent = autoSync ? 'Disable Auto-Sync' : 'Enable Auto-Sync';
            showNotification(autoSync ? 'Auto-sync enabled' : 'Auto-sync disabled');
        }

        // Timer persistence functions
        function persistCountSession() {
            if (countStartTime) {
                // Get currently selected workers
                const selectedWorkerIds = Array.from(document.querySelectorAll('#workerCheckboxes input[type="checkbox"]:checked'))
                    .map(cb => String(cb.value));
                
                console.log('Persisting session with workers:', selectedWorkerIds); // Debug log
                
                const sessionData = {
                    startTime: countStartTime.toISOString(),
                    pharmacyName: document.getElementById('pharmacyName').value.trim(),
                    notes: document.getElementById('countNotes').value.trim(),
                    workers: selectedWorkerIds,
                    scheduledStart: document.getElementById('countStartTime').value,
                    scheduledEnd: document.getElementById('countEndTime').value
                };
                localStorage.setItem('stockcount_active_session', JSON.stringify(sessionData));
            } else {
                localStorage.removeItem('stockcount_active_session');
            }
        }

        function restoreCountSession() {
            const savedSession = localStorage.getItem('stockcount_active_session');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    countStartTime = new Date(sessionData.startTime);
                    
                    // Restore form values
                    document.getElementById('pharmacyName').value = sessionData.pharmacyName || '';
                    document.getElementById('countNotes').value = sessionData.notes || '';
                    document.getElementById('countStartTime').value = sessionData.scheduledStart || '';
                    document.getElementById('countEndTime').value = sessionData.scheduledEnd || '';
                    
                    // First display worker checkboxes, then restore selections
                    displayWorkerCheckboxes();
                    
                    // Wait a moment for DOM to update, then restore worker selections
                    setTimeout(() => {
                        console.log('Restoring worker selections:', sessionData.workers); // Debug log
                        if (sessionData.workers && Array.isArray(sessionData.workers)) {
                            // First uncheck all
                            document.querySelectorAll('#workerCheckboxes input[type="checkbox"]').forEach(cb => {
                                cb.checked = false;
                            });
                            // Then check the saved ones
                            sessionData.workers.forEach(workerId => {
                                const checkbox = document.querySelector(`#workerCheckboxes input[value="${workerId}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log(`Restored selection for worker ${workerId}`); // Debug log
                                } else {
                                    console.log(`Could not find checkbox for worker ${workerId}`); // Debug log
                                }
                            });
                        }
                    }, 100);
                    
                    // Resume timer
                    resumeCount();
                } catch (error) {
                    console.error('Error restoring count session:', error);
                    localStorage.removeItem('stockcount_active_session');
                }
            }
        }

        function resumeCount() {
            if (countStartTime) {
                document.getElementById('startCountBtn').style.display = 'none';
                document.getElementById('stopCountBtn').style.display = 'block';
                document.getElementById('countTimer').style.display = 'block';
                
                // Update start time display
                const startTimeDisplay = document.getElementById('startTimeDisplay');
                startTimeDisplay.textContent = countStartTime.toLocaleTimeString();
                
                countInterval = setInterval(updateTimer, 1000);
                updateTimer(); // Initial update
                
                showNotification('Resumed count session from ' + countStartTime.toLocaleTimeString());
            }
        }

        // Data persistence functions
        function loadData() {
            const savedWorkers = localStorage.getItem('stockcount_workers');
            const savedHistory = localStorage.getItem('stockcount_history');
            
            if (savedWorkers) {
                workers = JSON.parse(savedWorkers);
            }
            if (savedHistory) {
                countHistory = JSON.parse(savedHistory);
            }
        }

        function saveData() {
            localStorage.setItem('stockcount_workers', JSON.stringify(workers));
            localStorage.setItem('stockcount_history', JSON.stringify(countHistory));
            updateStorageInfo();
            
            // Auto-sync if enabled
            if (autoSync && localStorage.getItem('syncKey')) {
                setTimeout(() => syncToCloud(true), 1000);
            }
        }

        function updateStorageInfo() {
            const data = JSON.stringify({ workers, countHistory });
            const sizeKB = Math.round(new Blob([data]).size / 1024 * 100) / 100;
            const storageElement = document.getElementById('storageUsed');
            if (storageElement) {
                storageElement.textContent = sizeKB + ' KB';
            }
        }

        // Enhanced timer functions
        function setCurrentTimes() {
            const now = new Date();
            const localNow = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
            
            document.getElementById('countStartTime').value = localNow.toISOString().slice(0, -8);
            
            // Set end time to 2 hours from now by default
            const endTime = new Date(now.getTime() + (2 * 60 * 60 * 1000));
            const localEndTime = new Date(endTime.getTime() - endTime.getTimezoneOffset() * 60000);
            document.getElementById('countEndTime').value = localEndTime.toISOString().slice(0, -8);
        }

        function startCount() {
            const pharmacyName = document.getElementById('pharmacyName').value.trim();
            if (!pharmacyName) {
                showNotification('Please enter a pharmacy name', 'danger');
                return;
            }

            const checkedWorkerIds = Array.from(document.querySelectorAll('#workerCheckboxes input[type="checkbox"]:checked')).map(cb => String(cb.value));
            console.log('Selected worker IDs:', checkedWorkerIds); // Debug log
            
            if (checkedWorkerIds.length === 0) {
                showNotification('Please select at least one worker', 'danger');
                return;
            }

            document.getElementById('startCountBtn').style.display = 'none';
            document.getElementById('stopCountBtn').style.display = 'block';
            document.getElementById('countTimer').style.display = 'block';

            countStartTime = new Date();
            
            // Update start time display
            const startTimeDisplay = document.getElementById('startTimeDisplay');
            startTimeDisplay.textContent = countStartTime.toLocaleTimeString();
            
            countInterval = setInterval(updateTimer, 1000);
            updateTimer(); // Initial update
            
            persistCountSession();
            showNotification(`Count started with ${checkedWorkerIds.length} workers!`);
        }

        function updateTimer() {
            if (!countStartTime) return;
            
            const now = new Date();
            const elapsed = Math.floor((now - countStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            const displayTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = displayTime;
        }

        function stopCount() {
            if (!countStartTime) return;

            clearInterval(countInterval);
            const countEndTime = new Date();
            const durationMs = countEndTime - countStartTime;

            // Get scheduled times
            const scheduledStartTime = document.getElementById('countStartTime').value;
            const scheduledEndTime = document.getElementById('countEndTime').value;

            const pharmacyName = document.getElementById('pharmacyName').value.trim();
            const notes = document.getElementById('countNotes').value.trim();
            
            // Get selected workers with comprehensive logging
            const checkboxContainer = document.getElementById('workerCheckboxes');
            console.log('Checkbox container exists:', !!checkboxContainer); // Debug log
            
            const allCheckboxes = document.querySelectorAll('#workerCheckboxes input[type="checkbox"]');
            console.log('Total checkboxes found:', allCheckboxes.length); // Debug log
            
            const checkedCheckboxes = document.querySelectorAll('#workerCheckboxes input[type="checkbox"]:checked');
            console.log('Checked checkboxes found:', checkedCheckboxes.length); // Debug log
            
            // Log each checkbox state
            allCheckboxes.forEach((cb, index) => {
                console.log(`Checkbox ${index}: value=${cb.value}, checked=${cb.checked}, id=${cb.id}`);
            });
            
            const checkedWorkerIds = Array.from(checkedCheckboxes).map(cb => {
                const id = String(cb.value);
                console.log('Processing checkbox value:', cb.value, 'parsed as:', id); // Debug log
                return id;
            });
            
            console.log('Stopping count - Selected worker IDs:', checkedWorkerIds); // Debug log
            console.log('Available workers in memory:', workers.map(w => ({ id: w.id, name: w.displayName }))); // Debug log
            
            const workersPresent = checkedWorkerIds.map(id => {
                const worker = workers.find(w => w.id === id);
                console.log(`Looking for worker ID ${id}:`, worker ? `Found: ${worker.displayName}` : 'NOT FOUND'); // Debug log
                return worker;
            }).filter(worker => worker !== undefined && worker !== null);
            
            console.log('Final workers present for history:', workersPresent.map(w => w.displayName)); // Debug log
            
            const newHistoryItem = {
                id: Date.now().toString() + '-' + Math.random().toString(36).slice(2),
                date: new Date().toISOString(),
                pharmacy: pharmacyName,
                workers: workersPresent,
                notes: notes,
                durationMs: durationMs,
                actualStartTime: countStartTime.toISOString(),
                actualEndTime: countEndTime.toISOString(),
                scheduledStartTime: scheduledStartTime || null,
                scheduledEndTime: scheduledEndTime || null
            };
            
            console.log('New history item being saved:', {
                id: newHistoryItem.id,
                pharmacy: newHistoryItem.pharmacy,
                workersCount: newHistoryItem.workers.length,
                workerNames: newHistoryItem.workers.map(w => w.displayName)
            }); // Debug log
            
            countHistory.push(newHistoryItem);
            saveData();
            displayHistory();
            updateDataStats();
            resetCountForm();
            
            // Clear session
            localStorage.removeItem('stockcount_active_session');
            countStartTime = null;
            
            showNotification(`Count recorded successfully with ${workersPresent.length} workers!`);
        }

        function resetCountForm() {
            // Don't uncheck boxes when resetting after a completed count
            // Only clear the form fields
            document.getElementById('pharmacyName').value = '';
            document.getElementById('countNotes').value = '';
            document.getElementById('countStartTime').value = '';
            document.getElementById('countEndTime').value = '';
            
            document.getElementById('startCountBtn').style.display = 'block';
            document.getElementById('stopCountBtn').style.display = 'none';
            document.getElementById('countTimer').style.display = 'none';
            document.getElementById('timerDisplay').textContent = '00:00:00';
            document.getElementById('startTimeDisplay').textContent = '--:--';
        }

        // Worker management functions
        function editWorker(workerId) {
            editingWorkerId = workerId;
            const worker = workers.find(w => w.id === workerId);
            if (!worker) return;

            document.getElementById('displayName').value = worker.displayName;
            document.getElementById('accountName').value = worker.accountName;
            document.getElementById('accountNumber').value = worker.accountNumber;
            document.getElementById('bankName').value = worker.bankName;

            document.getElementById('addWorkerBtn').textContent = 'Save Changes';
            document.getElementById('addWorkerBtn').classList.add('secondary');
            document.getElementById('cancelEditBtn').style.display = 'block';
        }

        function cancelEdit() {
            editingWorkerId = null;
            clearWorkerForm();
            document.getElementById('addWorkerBtn').textContent = 'Add Worker';
            document.getElementById('addWorkerBtn').classList.remove('secondary');
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function handleAddWorker() {
            const displayName = document.getElementById('displayName').value.trim();
            const accountName = document.getElementById('accountName').value.trim();
            const accountNumber = document.getElementById('accountNumber').value.trim();
            const bankName = document.getElementById('bankName').value.trim();

            if (!displayName || !accountName || !accountNumber || !bankName) {
                showNotification('Please fill in all fields', 'danger');
                return;
            }

            // Check for duplicate account number (except when editing the same worker)
            const duplicate = workers.find(w => w.accountNumber === accountNumber && w.id !== editingWorkerId);
            if (duplicate) {
                showNotification('Account number already exists', 'danger');
                return;
            }

            if (editingWorkerId) {
                // Edit existing worker
                const workerIndex = workers.findIndex(w => w.id === editingWorkerId);
                if (workerIndex > -1) {
                    workers[workerIndex] = {
                        ...workers[workerIndex],
                        displayName,
                        accountName,
                        accountNumber,
                        bankName
                    };
                    showNotification('Worker updated successfully!');
                }
            } else {
                // Add new worker
                const newWorker = {
                    id: Date.now().toString() + '-' + Math.random().toString(36).slice(2).toString() + '-' + Math.random().toString(36).slice(2),
                    displayName,
                    accountName,
                    accountNumber,
                    bankName
                };
                workers.push(newWorker);
                showNotification('Worker added successfully!');
            }
            
            saveData();
            displayWorkers();
            displayWorkerCheckboxes();
            updateDataStats();
            clearWorkerForm();
            cancelEdit();
        }

        function clearWorkerForm() {
            document.getElementById('displayName').value = '';
            document.getElementById('accountName').value = '';
            document.getElementById('accountNumber').value = '';
            document.getElementById('bankName').value = '';
        }

        function deleteWorker(id) {
            if (confirm('Are you sure you want to delete this worker?')) {
                workers = workers.filter(worker => worker.id !== id);
                saveData();
                displayWorkers();
                displayWorkerCheckboxes();
                updateDataStats();
                showNotification('Worker deleted successfully!');
            }
        }

        function displayWorkers() {
            const list = document.getElementById('workersList');
            if (workers.length === 0) {
                list.innerHTML = `<div class="empty-state">
                    <p>No workers added yet</p>
                </div>`;
                return;
            }

            const sortedWorkers = [...workers].sort((a, b) => a.displayName.localeCompare(b.displayName));
            list.innerHTML = sortedWorkers.map(worker => `
                <div class="worker-item">
                    <div class="worker-info">
                        <h4>${worker.displayName}</h4>
                        <p>${worker.accountName} • ${worker.accountNumber} • ${worker.bankName}</p>
                    </div>
                    <div class="worker-actions">
                        <button class="btn secondary" onclick="editWorker('${worker.id}')">Edit</button>
                        <button class="btn danger" onclick="deleteWorker('${worker.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function filterWorkers() {
            const searchTerm = document.getElementById('workerSearch').value.toLowerCase();
            const clearBtn = document.querySelector('#workerSearch').nextElementSibling;
            clearBtn.style.display = searchTerm ? 'block' : 'none';

            if (!searchTerm) {
                displayWorkers();
                return;
            }

            const filteredWorkers = workers.filter(worker =>
                worker.displayName.toLowerCase().includes(searchTerm) ||
                worker.accountName.toLowerCase().includes(searchTerm) ||
                worker.bankName.toLowerCase().includes(searchTerm) ||
                worker.accountNumber.includes(searchTerm)
            );
            
            const list = document.getElementById('workersList');
            if (filteredWorkers.length === 0) {
                list.innerHTML = `<div class="empty-state"><p>No workers found</p></div>`;
                return;
            }

            list.innerHTML = filteredWorkers.map(worker => `
                <div class="worker-item">
                    <div class="worker-info">
                        <h4>${worker.displayName}</h4>
                        <p>${worker.accountName} • ${worker.accountNumber} • ${worker.bankName}</p>
                    </div>
                    <div class="worker-actions">
                        <button class="btn secondary" onclick="editWorker('${worker.id}')">Edit</button>
                        <button class="btn danger" onclick="deleteWorker('${worker.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function clearWorkerSearch() {
            document.getElementById('workerSearch').value = '';
            filterWorkers();
        }
        
        // Count management functions
        function displayWorkerCheckboxes() {
            const checkboxList = document.getElementById('workerCheckboxes');
            const sortedWorkers = [...workers].sort((a, b) => a.displayName.localeCompare(b.displayName));
            
            if (workers.length === 0) {
                checkboxList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No workers available</p>';
                return;
            }

            // Store current selections before rebuilding (only if checkboxes exist)
            const currentSelections = new Set();
            const existingCheckboxes = checkboxList.querySelectorAll('input[type="checkbox"]:checked');
            existingCheckboxes.forEach(cb => {
                currentSelections.add(String(cb.value));
            });

            // If this is the first time loading or no previous selections exist, default to unchecked
            const hasExistingSelections = existingCheckboxes.length > 0;

            checkboxList.innerHTML = sortedWorkers.map(worker => {
                const isChecked = hasExistingSelections ? currentSelections.has(worker.id) : false;
                return `
                    <div class="checkbox-item" data-worker-id="${worker.id}">
                        <input type="checkbox" id="worker-${worker.id}" value="${worker.id}" ${isChecked ? 'checked' : ''}>
                        <label for="worker-${worker.id}">${worker.displayName}</label>
                    </div>
                `;
            }).join('');
        }

        function filterCountWorkers() {
            const searchTerm = document.getElementById('countWorkerSearch').value.toLowerCase();
            const clearBtn = document.querySelector('#countWorkerSearch').nextElementSibling;
            clearBtn.style.display = searchTerm ? 'block' : 'none';

            const checkboxItems = document.querySelectorAll('#workerCheckboxes .checkbox-item');
            checkboxItems.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function clearCountWorkerSearch() {
            document.getElementById('countWorkerSearch').value = '';
            filterCountWorkers();
        }

        // History management functions with enhanced worker export
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            if (countHistory.length === 0) {
                historyList.innerHTML = `<div class="empty-state">
                    <p>No count history yet</p>
                </div>`;
                return;
            }
            
            const sortedHistory = [...countHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            historyList.innerHTML = sortedHistory.map(item => {
                const date = new Date(item.date).toLocaleString();
                const duration = formatDuration(item.durationMs);
                const workerNames = item.workers.map(w => w.displayName).join(', ');
                const isSelected = selectedHistoryIds.has(item.id);
                
                // Format scheduled vs actual times
                let timeInfo = '';
                if (item.scheduledStartTime && item.scheduledEndTime) {
                    const scheduledStart = new Date(item.scheduledStartTime).toLocaleTimeString();
                    const scheduledEnd = new Date(item.scheduledEndTime).toLocaleTimeString();
                    const actualStart = new Date(item.actualStartTime).toLocaleTimeString();
                    const actualEnd = new Date(item.actualEndTime).toLocaleTimeString();
                    timeInfo = `<p><strong>Scheduled:</strong> ${scheduledStart} - ${scheduledEnd}</p>
                               <p><strong>Actual:</strong> ${actualStart} - ${actualEnd}</p>`;
                } else if (item.actualStartTime && item.actualEndTime) {
                    const actualStart = new Date(item.actualStartTime).toLocaleTimeString();
                    const actualEnd = new Date(item.actualEndTime).toLocaleTimeString();
                    timeInfo = `<p><strong>Time:</strong> ${actualStart} - ${actualEnd}</p>`;
                }
                
                return `
                    <div class="history-item ${isSelected ? 'selected' : ''}" data-id="${item.id}">
                        <div class="history-info" ${selectMode ? `onclick="toggleHistorySelection('${item.id}')"` : ''} style="flex: 1;">
                            <h4>${item.pharmacy} <span class="time-badge">${duration}</span></h4>
                            <p><strong>Date:</strong> ${date}</p>
                            ${timeInfo}
                            <p><strong>Workers (${item.workers.length}):</strong> ${workerNames}</p>
                            ${item.notes ? `<p><strong>Notes:</strong> ${item.notes}</p>` : ''}
                        </div>
                        ${!selectMode ? `
                        <div class="history-actions" style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn secondary" onclick="exportSingleHistory('${item.id}', 'txt')" style="font-size: 12px; padding: 6px 12px;">Export TXT</button>
                            <button class="btn secondary" onclick="exportSingleHistory('${item.id}', 'csv')" style="font-size: 12px; padding: 6px 12px;">Export CSV</button>
                            <button class="btn danger" onclick="deleteHistory('${item.id}')" style="font-size: 12px; padding: 6px 12px;">Delete</button>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Enhanced export functions with full worker details
        function exportSingleHistory(id, format) {
            const item = countHistory.find(h => h.id === id);
            if (!item) return;

            const date = new Date(item.date).toLocaleString();
            const duration = formatDuration(item.durationMs);

            if (format === 'txt') {
                let text = 'Stock Count Report\n' + '='.repeat(50) + '\n\n';
                text += `Pharmacy: ${item.pharmacy}\n`;
                text += `Date: ${date}\n`;
                text += `Duration: ${duration}\n\n`;
                
                if (item.scheduledStartTime && item.scheduledEndTime) {
                    text += `Scheduled Time: ${new Date(item.scheduledStartTime).toLocaleString()} - ${new Date(item.scheduledEndTime).toLocaleString()}\n`;
                }
                if (item.actualStartTime && item.actualEndTime) {
                    text += `Actual Time: ${new Date(item.actualStartTime).toLocaleString()} - ${new Date(item.actualEndTime).toLocaleString()}\n\n`;
                }
                
                text += `Workers Present (${item.workers.length}):\n`;
                text += '-'.repeat(30) + '\n';
                item.workers.forEach((worker, index) => {
                    text += `${index + 1}. ${worker.displayName}\n`;
                    text += `   Account: ${worker.accountName}\n`;
                    text += `   Number: ${worker.accountNumber}\n`;
                    text += `   Bank: ${worker.bankName}\n\n`;
                });
                
                if (item.notes) {
                    text += `Notes:\n${item.notes}\n`;
                }
                
                const filename = `count_${item.pharmacy.replace(/\s+/g, '_')}_${new Date(item.date).toISOString().split('T')[0]}.txt`;
                downloadFile(filename, text, 'text/plain');
            } else {
                let csvContent = "Date,Pharmacy,Duration (minutes),Scheduled Start,Scheduled End,Actual Start,Actual End,Worker Name,Account Name,Account Number,Bank,Notes\n";
                
                const durationMins = Math.round(item.durationMs / 60000);
                const scheduledStart = item.scheduledStartTime ? new Date(item.scheduledStartTime).toLocaleString() : '';
                const scheduledEnd = item.scheduledEndTime ? new Date(item.scheduledEndTime).toLocaleString() : '';
                const actualStart = item.actualStartTime ? new Date(item.actualStartTime).toLocaleString() : '';
                const actualEnd = item.actualEndTime ? new Date(item.actualEndTime).toLocaleString() : '';
                const notes = (item.notes || '').replace(/"/g, '""');
                
                if (item.workers.length > 0) {
                    item.workers.forEach(worker => {
                        const row = `"${date}","${item.pharmacy}",${durationMins},"${scheduledStart}","${scheduledEnd}","${actualStart}","${actualEnd}","${worker.displayName}","${worker.accountName}","${worker.accountNumber}","${worker.bankName}","${notes}"\n`;
                        csvContent += row;
                    });
                } else {
                    const row = `"${date}","${item.pharmacy}",${durationMins},"${scheduledStart}","${scheduledEnd}","${actualStart}","${actualEnd}","","","","","${notes}"\n`;
                    csvContent += row;
                }
                
                const filename = `count_${item.pharmacy.replace(/\s+/g, '_')}_${new Date(item.date).toISOString().split('T')[0]}.csv`;
                downloadFile(filename, csvContent, 'text/csv');
            }
            
            showNotification('Report exported successfully!');
        }

        function exportSelectedAsTxt() {
            if (selectedHistoryIds.size === 0) {
                showNotification('Please select at least one item to export.', 'danger');
                return;
            }

            const selectedItems = countHistory.filter(item => selectedHistoryIds.has(item.id));
            let text = 'Stock Count Report\n' + '='.repeat(50) + '\n\n';
            
            selectedItems.forEach((item, index) => {
                const date = new Date(item.date).toLocaleString();
                const duration = formatDuration(item.durationMs);

                text += `Count ${index + 1}\n`;
                text += `Pharmacy: ${item.pharmacy}\n`;
                text += `Date: ${date}\n`;
                text += `Duration: ${duration}\n`;
                
                if (item.scheduledStartTime && item.scheduledEndTime) {
                    text += `Scheduled: ${new Date(item.scheduledStartTime).toLocaleString()} - ${new Date(item.scheduledEndTime).toLocaleString()}\n`;
                }
                if (item.actualStartTime && item.actualEndTime) {
                    text += `Actual: ${new Date(item.actualStartTime).toLocaleString()} - ${new Date(item.actualEndTime).toLocaleString()}\n`;
                }
                
                text += `Workers (${item.workers.length}):\n`;
                item.workers.forEach((worker, workerIndex) => {
                    text += `  ${workerIndex + 1}. ${worker.displayName} (${worker.accountName}, ${worker.accountNumber}, ${worker.bankName})\n`;
                });
                
                if (item.notes) {
                    text += `Notes: ${item.notes}\n`;
                }
                text += '-'.repeat(30) + '\n\n';
            });
            
            downloadFile('stock_count_report.txt', text, 'text/plain');
            showNotification('Report exported successfully!');
        }

        function exportSelectedAsExcel() {
            if (selectedHistoryIds.size === 0) {
                showNotification('Please select at least one item to export.', 'danger');
                return;
            }

            const selectedItems = countHistory.filter(item => selectedHistoryIds.has(item.id));
            let csvContent = "Date,Pharmacy,Duration (minutes),Scheduled Start,Scheduled End,Actual Start,Actual End,Worker Name,Account Name,Account Number,Bank,Notes\n";

            selectedItems.forEach(item => {
                const date = new Date(item.date).toLocaleString();
                const durationMins = Math.round(item.durationMs / 60000);
                const scheduledStart = item.scheduledStartTime ? new Date(item.scheduledStartTime).toLocaleString() : '';
                const scheduledEnd = item.scheduledEndTime ? new Date(item.scheduledEndTime).toLocaleString() : '';
                const actualStart = item.actualStartTime ? new Date(item.actualStartTime).toLocaleString() : '';
                const actualEnd = item.actualEndTime ? new Date(item.actualEndTime).toLocaleString() : '';
                const notes = (item.notes || '').replace(/"/g, '""');
                
                if (item.workers.length > 0) {
                    item.workers.forEach(worker => {
                        const row = `"${date}","${item.pharmacy}",${durationMins},"${scheduledStart}","${scheduledEnd}","${actualStart}","${actualEnd}","${worker.displayName}","${worker.accountName}","${worker.accountNumber}","${worker.bankName}","${notes}"\n`;
                        csvContent += row;
                    });
                } else {
                    const row = `"${date}","${item.pharmacy}",${durationMins},"${scheduledStart}","${scheduledEnd}","${actualStart}","${actualEnd}","","","","","${notes}"\n`;
                    csvContent += row;
                }
            });
            
            downloadFile('stock_count_report.csv', csvContent, 'text/csv');
            showNotification('Report exported successfully!');
        }

        function deleteHistory(id) {
            console.log('Delete button clicked for ID:', id); // Debug log
            console.log('Current history items:'); // Debug log
            countHistory.forEach((item, index) => {
                console.log(`${index}: ID=${item.id}, Pharmacy=${item.pharmacy}`);
            });
            
            if (confirm('Are you sure you want to delete this count record?')) {
                const initialLength = countHistory.length;
                const itemToDelete = countHistory.find(item => String(item.id) === String(id)); // Use == for type coercion
                console.log('Item to delete:', itemToDelete); // Debug log
                
                countHistory = countHistory.filter(item => String(item.id) !== String(id)); // Use != for type coercion
                const newLength = countHistory.length;
                
                console.log(`History length before: ${initialLength}, after: ${newLength}`);
                
                if (newLength < initialLength) {
                    saveData();
                    displayHistory();
                    updateDataStats();
                    showNotification('Count record deleted');
                    console.log('Successfully deleted item'); // Debug log
                } else {
                    console.error(`Failed to delete history item with ID: ${id}`);
                    console.error('Available IDs:', countHistory.map(item => `${item.id} (${typeof item.id})`));
                    console.error('Target ID:', `${id} (${typeof id})`);
                    showNotification('Error: Could not delete record', 'danger');
                }
            } else {
                console.log('User cancelled deletion'); // Debug log
            }
        }

        function deleteSelected() {
            if (selectedHistoryIds.size === 0) {
                showNotification('Please select items to delete', 'danger');
                return;
            }

            if (confirm(`Are you sure you want to delete ${selectedHistoryIds.size} selected count record(s)?`)) {
                countHistory = countHistory.filter(item => !selectedHistoryIds.has(item.id));
                selectedHistoryIds.clear();
                saveData();
                displayHistory();
                updateDataStats();
                showNotification('Selected records deleted');
            }
        }

        function formatDuration(ms) {
            if (ms < 1000) return '0s';
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const remainingMins = minutes % 60;
            const remainingSecs = seconds % 60;

            let formatted = '';
            if (hours > 0) formatted += `${hours}h `;
            if (remainingMins > 0) formatted += `${remainingMins}m `;
            if (remainingSecs > 0 && hours === 0) formatted += `${remainingSecs}s`;
            return formatted.trim();
        }

        function updateDataStats() {
            const totalCounts = countHistory.length;
            document.getElementById('totalCounts').textContent = totalCounts;

            if (totalCounts > 0) {
                const totalWorkers = countHistory.reduce((sum, item) => sum + item.workers.length, 0);
                document.getElementById('avgWorkers').textContent = (totalWorkers / totalCounts).toFixed(1);

                const totalDurationMs = countHistory.reduce((sum, item) => sum + item.durationMs, 0);
                const avgDurationMs = totalDurationMs / totalCounts;
                document.getElementById('avgDuration').textContent = `${Math.round(avgDurationMs / 60000)}m`;

                const workerCounts = {};
                countHistory.forEach(item => {
                    item.workers.forEach(worker => {
                        workerCounts[worker.displayName] = (workerCounts[worker.displayName] || 0) + 1;
                    });
                });

                const mostUsedWorker = Object.keys(workerCounts).length > 0 
                    ? Object.keys(workerCounts).reduce((a, b) => workerCounts[a] > workerCounts[b] ? a : b) 
                    : '-';
                document.getElementById('mostUsedWorker').textContent = mostUsedWorker;
            } else {
                document.getElementById('avgWorkers').textContent = '0';
                document.getElementById('avgDuration').textContent = '0m';
                document.getElementById('mostUsedWorker').textContent = '-';
            }

            document.getElementById('workerCount').textContent = workers.length;
            document.getElementById('historyCount').textContent = countHistory.length;
        }

        function toggleSelectMode() {
            selectMode = !selectMode;
            document.getElementById('selectModeControls').style.display = selectMode ? 'block' : 'none';
            if (!selectMode) {
                clearSelection();
            }
            displayHistory();
        }
        
        function toggleHistorySelection(id) {
            if (!selectMode) return;
            
            if (selectedHistoryIds.has(id)) {
                selectedHistoryIds.delete(id);
            } else {
                selectedHistoryIds.add(id);
            }
            displayHistory();
        }
        
        function selectAll() {
            selectedHistoryIds = new Set(countHistory.map(item => item.id));
            displayHistory();
        }

        function clearSelection() {
            selectedHistoryIds.clear();
            displayHistory();
        }

        // Backup & Restore functions
        function exportBackup() {
            const data = {
                workers: workers,
                countHistory: countHistory,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            const jsonString = JSON.stringify(data, null, 2);
            const filename = `stock_count_backup_${new Date().toISOString().split('T')[0]}.json`;
            downloadFile(filename, jsonString, 'application/json');
            showNotification('Backup exported successfully!');
        }

        function importBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            if (!file) {
                showNotification('Please select a backup file to import.', 'danger');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let importedWorkers = 0;
                    let importedHistory = 0;

                    if (importedData.workers && Array.isArray(importedData.workers)) {
                        importedData.workers.forEach(impWorker => {
                            if (!workers.some(localWorker => localWorker.accountNumber === impWorker.accountNumber)) {
                                workers.push({
                                    ...impWorker,
                                    id: impWorker.id || Date.now().toString() + '-' + Math.random().toString(36).slice(2)
                                });
                                importedWorkers++;
                            }
                        });
                    }

                    if (importedData.countHistory && Array.isArray(importedData.countHistory)) {
                        importedData.countHistory.forEach(impItem => {
                            if (!countHistory.some(localItem => localItem.id === impItem.id)) {
                                countHistory.push(impItem);
                                importedHistory++;
                            }
                        });
                    }
                    
                    saveData();
                    displayWorkers();
                    displayWorkerCheckboxes();
                    displayHistory();
                    updateDataStats();
                    
                    showNotification(`Import completed: ${importedWorkers} workers, ${importedHistory} history items`);
                    fileInput.value = '';
                } catch (error) {
                    showNotification('Invalid backup file. Please ensure it is a valid JSON.', 'danger');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete all data? This cannot be undone.')) {
                workers = [];
                countHistory = [];
                selectedHistoryIds.clear();
                localStorage.removeItem('stockcount_workers');
                localStorage.removeItem('stockcount_history');
                localStorage.removeItem('stockcount_active_session');
                
                displayWorkers();
                displayWorkerCheckboxes();
                displayHistory();
                updateDataStats();
                cancelEdit();
                resetCountForm();
                showNotification('All data has been cleared.');
            }
        }

        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // UI and utility functions
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }

        function showNotification(message, type = 'success') {
            const notificationBar = document.getElementById('notificationBar');
            notificationBar.textContent = message;
            notificationBar.className = `notification-bar show ${type}`;
            setTimeout(() => {
                notificationBar.classList.remove('show');
            }, 3000);
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
            }
            
            // Persist count session on page visibility change
            document.addEventListener('visibilitychange', function() {
                if (countStartTime) {
                    persistCountSession();
                }
            });

            // Persist count session before page unload
            window.addEventListener('beforeunload', function() {
                if (countStartTime) {
                    persistCountSession();
                }
            });
            
            initApp();
        });
    </script>
</body>
</html>
